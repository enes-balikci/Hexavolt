<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexavolt</title>
    <link rel="stylesheet" href="style.css">
    <!-- MiniSearch CDN -->
    <script src="https://cdn.jsdelivr.net/npm/minisearch@6.4.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
</head>
<body>
    <div class="container">
        <svg class="logo" viewBox="0 0 100 100">
            <polygon points="50,15 90,35 90,75 50,95 10,75 10,35" fill="#5fffd6" />
            <text x="50%" y="60%" text-anchor="middle" fill="#181c24" font-size="36px" font-family="Arial" dy=".3em">H</text>
        </svg>
        <h1>Hexavolt</h1>
        <p>Indexation technique avancée du matériel électrique en France.</p>
        <input type="text" id="searchBox" placeholder="Rechercher un produit, une marque, une référence..." style="width:100%;padding:12px 8px;font-size:1em;margin:30px 0 20px 0;">
        <div id="webgl-canvas" style="width:100%;height:350px;background:#171c24;border-radius:12px;margin-bottom:24px;"></div>
        <div id="filters" style="margin-bottom:24px;"></div>
        <div id="results"></div>
    </div>
    <script>
        // Genişletilebilir ürün veri seti (örnek, daha fazlası eklenebilir)
        const products = [
            {
                "id": 1,
                "nom": "Prise électrique 16A",
                "societe": "Legrand",
                "reference": "LEG-1234",
                "description": "Prise murale standard française, 16A, blanche.",
                "categorie": "Prises",
                "site": "https://www.legrand.fr",
                "prix": 4.20,
                "stock": 120,
                "tags": ["prise", "16A", "murale", "blanche"]
            },
            {
                "id": 2,
                "nom": "Disjoncteur 20A",
                "societe": "Schneider Electric",
                "reference": "SCH-2345",
                "description": "Disjoncteur modulaire, 20A, Courbe C, protection avancée.",
                "categorie": "Disjoncteurs",
                "site": "https://www.se.com/fr",
                "prix": 12.90,
                "stock": 60,
                "tags": ["disjoncteur", "20A", "modulaire"]
            },
            {
                "id": 3,
                "nom": "Interrupteur va-et-vient",
                "societe": "Hager",
                "reference": "HAG-4567",
                "description": "Interrupteur simple, finition aluminium.",
                "categorie": "Interrupteurs",
                "site": "https://www.hager.fr",
                "prix": 7.50,
                "stock": 200,
                "tags": ["interrupteur", "va-et-vient", "aluminium"]
            },
            {
                "id": 4,
                "nom": "Boîte d'encastrement",
                "societe": "Legrand",
                "reference": "LEG-5678",
                "description": "Boîte pour installation murale, Ø67mm.",
                "categorie": "Accessoires",
                "site": "https://www.legrand.fr",
                "prix": 1.20,
                "stock": 500,
                "tags": ["boîte", "encastrement", "murale"]
            },
            {
                "id": 5,
                "nom": "Gaine ICTA 16mm",
                "societe": "Courant",
                "reference": "COU-8910",
                "description": "Gaine annelée pour câblage, 16mm, 100m.",
                "categorie": "Gaines",
                "site": "https://www.courant.fr",
                "prix": 38.00,
                "stock": 35,
                "tags": ["gaine", "ICTA", "16mm", "câblage"]
            }
            // ...daha fazla ürün eklenebilir
        ];

        // Facet/filtresi için yardımcı
        function getFacets(list, field) {
            const counts = {};
            list.forEach(item => {
                if(!counts[item[field]]) counts[item[field]] = 0;
                counts[item[field]]++;
            });
            return Object.entries(counts).map(([val, count]) => ({val, count}));
        }

        // MiniSearch ile index oluşturma
        const miniSearch = new MiniSearch({
            fields: ['nom', 'societe', 'reference', 'description', 'categorie', 'tags'], // indexlenecek alanlar
            storeFields: ['nom', 'societe', 'reference', 'description', 'categorie', 'site', 'prix', 'stock', 'tags'], // sonuçlarda gösterilecekler
            searchOptions: {
                boost: { nom: 6, categorie: 3, societe: 3, tags: 4, description: 2, reference: 4 },
                fuzzy: 0.2, // yazım hatalarını tolere et
                prefix: true // kelime başı eşleşmeleri de bul
            }
        });
        miniSearch.addAll(products);

        // Facet filtreleri oluştur
        function renderFilters(selected = {}) {
            let html = '<strong>Filtrer par:</strong><br>';
            // Facet: Catégorie
            const catFacets = getFacets(products, 'categorie');
            html += 'Catégorie: <select id="catFilter"><option value="">Toutes</option>';
            catFacets.forEach(f => {
                html += `<option value="${f.val}" ${selected.categorie===f.val?'selected':''}>${f.val} (${f.count})</option>`;
            });
            html += '</select> ';
            // Facet: Société
            const socFacets = getFacets(products, 'societe');
            html += 'Société: <select id="socFilter"><option value="">Toutes</option>';
            socFacets.forEach(f => {
                html += `<option value="${f.val}" ${selected.societe===f.val?'selected':''}>${f.val} (${f.count})</option>`;
            });
            html += '</select>';
            document.getElementById('filters').innerHTML = html;
        }

        // Sonuçları göster
        function renderResults(results, highlight = {}) {
            let html = '';
            if(results.length === 0){
                html = "<p>Aucun résultat trouvé.</p>";
            } else {
                html = `<p style="opacity:.7">${results.length} résultat(s) trouvé(s)</p><ul style='padding:0;list-style:none'>`;
                results.forEach(res => {
                    const prod = res;
                    // Vurgulu eşleşme snippet'i
                    let name = prod.nom;
                    if(res._highlights && res._highlights.nom) name = res._highlights.nom;
                    html += `<li style="margin-bottom:22px;background:#232938;padding:18px;border-radius:8px;text-align:left;">
                        <strong>${name}</strong> <span style="color:#5fffd6;">[${prod.societe}]</span><br>
                        <small>Réf: ${prod.reference} | Catégorie: ${prod.categorie}</small><br>
                        <span>${prod.description}</span><br>
                        <span style="color:#8af;font-size:.95em;">Prix: ${prod.prix.toFixed(2)} € | Stock: ${prod.stock}</span><br>
                        <a href="${prod.site}" target="_blank" style="color:#5fffd6;text-decoration:underline;">Voir le site</a>
                    </li>`;
                });
                html += "</ul>";
            }
            document.getElementById('results').innerHTML = html;
        }

        // Arama ve filtreleme işlemi
        function searchAndFilter() {
            const query = document.getElementById('searchBox').value;
            const cat = document.getElementById('catFilter').value;
            const soc = document.getElementById('socFilter').value;

            let results = query.trim().length > 0
                ? miniSearch.search(query, { combineWith: "AND", extractField: (doc, fieldName) => doc[fieldName] })
                : products.map(p => ({ ...p, id: p.id }));

            // Facet filtreleri uygula
            if(cat) results = results.filter(r => r.categorie === cat);
            if(soc) results = results.filter(r => r.societe === soc);

            // vurgulu snippet ekle (MiniSearch 6.4.0+, _highlights ile)
            renderResults(results);
        }

        // Filtre değişimlerinde çalıştır
        document.addEventListener('DOMContentLoaded', function(){
            renderFilters();
            renderResults(products);
            document.getElementById('searchBox').addEventListener('input', searchAndFilter);
            document.getElementById('filters').addEventListener('change', searchAndFilter);
        });
    </script>
    <script>
/* --- WebGL teknik indexleme görselleştirmesi için üç boyutlu arayüz --- */

// (products dizininde en az 5-10 ürün olmalı, yukarıdaki MiniSearch örneğiyle uyumlu olmalı)
const canvasDiv = document.getElementById('webgl-canvas');
let renderer, scene, camera, controls, pickableObjects = [], raycaster, mouse, INTERSECTED;

// THREE.js başlat
function initWebGL(productsToShow) {
    // Temizle
    if(renderer && renderer.domElement) {
        renderer.dispose && renderer.dispose();
        canvasDiv.innerHTML = '';
    }
    // Renderer
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setClearColor(0x171c24);
    renderer.setSize(canvasDiv.clientWidth, canvasDiv.clientHeight);
    canvasDiv.appendChild(renderer.domElement);

    // Scene ve Camera
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, canvasDiv.clientWidth/canvasDiv.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 40);

    // Işıklar
    scene.add(new THREE.AmbientLight(0xffffff, 1));
    let dirLight = new THREE.DirectionalLight(0xcccccc, 0.7);
    dirLight.position.set(0, 10, 40);
    scene.add(dirLight);

    // Pickable nesneler
    pickableObjects = [];

    // Ürünleri 3D uzaya dağıt (dairesel veya grid)
    const N = productsToShow.length;
    const rad = 12 + Math.min(18, N*1.5);
    productsToShow.forEach((prod, i) => {
        const angle = (i/N) * Math.PI*2;
        const geo = new THREE.BoxGeometry(2,2,2);
        const mat = new THREE.MeshPhongMaterial({
            color: 0x5fffd6, 
            emissive: 0x141d22,
            shininess: 80,
            transparent:true, opacity:0.85
        });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(
            Math.cos(angle)*rad, 
            Math.sin(angle)*rad, 
            Math.sin(angle*2)*rad/5
        );
        mesh.userData = prod;
        scene.add(mesh);
        pickableObjects.push(mesh);

        // Etiket (ürün adı)
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 128;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#151c22';
        ctx.fillRect(0,0,128,128);
        ctx.font = 'bold 20px Arial';
        ctx.fillStyle = '#5fffd6';
        ctx.textAlign = 'center';
        ctx.fillText(prod.nom, 64, 68, 120);
        const tex = new THREE.CanvasTexture(canvas);
        const labelMat = new THREE.SpriteMaterial({map:tex, transparent:true});
        const label = new THREE.Sprite(labelMat);
        label.scale.set(6,1.6,1);
        label.position.copy(mesh.position).add(new THREE.Vector3(0,2,0));
        scene.add(label);
    });

    // Raycaster
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    // Kamera kontrolleri (isteğe bağlı: mouse drag için)
    // Basit kontrol (rotate için)
    let isDragging = false, lastX=0, lastY=0, azimuth=0, polar=0;
    canvasDiv.onmousedown = (e) => { isDragging=true; lastX=e.clientX; lastY=e.clientY; };
    canvasDiv.onmouseup = () => { isDragging=false; };
    canvasDiv.onmousemove = (e) => {
        if(isDragging){
            azimuth += (e.clientX-lastX)*0.013;
            polar += (e.clientY-lastY)*0.013;
            polar = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2-0.1, polar));
            lastX=e.clientX; lastY=e.clientY;
            camera.position.x = Math.sin(azimuth)*Math.cos(polar)*40;
            camera.position.y = Math.sin(polar)*40;
            camera.position.z = Math.cos(azimuth)*Math.cos(polar)*40;
            camera.lookAt(0,0,0);
        }
    };

    // Mouse pick & highlight
    canvasDiv.addEventListener('mousemove', (event) => {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    });
    canvasDiv.addEventListener('click', (event) => {
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(pickableObjects);
        if(intersects.length>0) {
            const prod = intersects[0].object.userData;
            alert(
                `Nom: ${prod.nom}\nSociété: ${prod.societe}\nCatégorie: ${prod.categorie}\nRéf: ${prod.reference}\nPrix: ${prod.prix}€\nStock: ${prod.stock}\nSite: ${prod.site}`
            );
        }
    });

    // Animasyon döngüsü & highlight
    function animate() {
        requestAnimationFrame(animate);
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(pickableObjects);
        pickableObjects.forEach(obj => obj.material.emissive.setHex(0x141d22));
        if(intersects.length>0) {
            intersects[0].object.material.emissive.setHex(0x00ff88);
        }
        renderer.render(scene, camera);
    }
    animate();
}

// Klasik aramanın her sonucunda 3D WebGL sahnesini güncelle
function updateWebGLFromSearch(results) {
    // Eğer MiniSearch ile geliyorsa, orijinal ürün objesine ulaşmak için:
    let arr = results.map(r => r.nom ? r : products.find(p=>p.id==r.id));
    if(arr.length === 0) arr = products;
    initWebGL(arr);
}

// Sayfa ilk yüklenince başlat
document.addEventListener('DOMContentLoaded', function(){
    updateWebGLFromSearch(products);
    // Arama kutunu ve filtrelerini dinle
    const searchInput = document.getElementById('searchBox');
    const filters = document.getElementById('filters');
    if(searchInput) searchInput.addEventListener('input', doSearchAndUpdateWebGL);
    if(filters) filters.addEventListener('change', doSearchAndUpdateWebGL);
});

function doSearchAndUpdateWebGL() {
    // Kendi arama fonksiyonunu burada çağır ve sonucu updateWebGLFromSearch ile ilet!
    // Örneğin yukarıdaki MiniSearch örneğindeki searchAndFilter fonksiyonunu burada çağırabilirsin.
    // Aşağıdaki örnek, MiniSearch kullandığını varsayar:
    const query = document.getElementById('searchBox').value;
    const catFilter = document.getElementById('catFilter')?.value || "";
    const socFilter = document.getElementById('socFilter')?.value || "";
    let results = query.trim().length > 0
        ? miniSearch.search(query, { combineWith: "AND" })
        : products.map(p => ({ ...p, id: p.id }));
    if(catFilter) results = results.filter(r => r.categorie === catFilter);
    if(socFilter) results = results.filter(r => r.societe === socFilter);
    updateWebGLFromSearch(results);
}
</script>
</body>
</html>
